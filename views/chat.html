<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div id="chat">
        <!-- A message for users on legacy browsers -->
        <noscript>
            <p style="text-align: center; background: #ffc; padding: 5px;">
                <b>Note:</b> Please refresh this page manually to see new messages from others.
            </p>
        </noscript>
        
        <div id="messages"><pre>CHAT_HISTORY_PLACEHOLDER</pre></div>

        <form id="form" action="/message" method="POST">
            <input type="hidden" id="username-hidden" name="username" value="USERNAME_PLACEHOLDER">
            <input id="input" name="message" autocomplete="off" required placeholder="Type a message..." />
            <button type="submit">Send</button>
        </form>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // This entire script will only run effectively in modern browsers.
        // It will fail gracefully or be ignored by Opera Mini 4.4.

        const messagesContainer = document.getElementById('messages');
        const messagesPre = messagesContainer.querySelector('pre');
        const form = document.getElementById('form');
        const input = document.getElementById('input');

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Scroll to the bottom as soon as the page loads.
        scrollToBottom();

        // Check if WebSockets are supported.
        if (typeof io === 'function') {
            // Hide the <noscript> message for modern users.
            const noscriptTag = document.querySelector('noscript');
            if (noscriptTag) { noscriptTag.style.display = 'none'; }
            
            const socket = io();
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                if (input.value) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const username = urlParams.get('username');
                    socket.emit('chat message', { username: username, msg: input.value });
                    input.value = '';
                }
            });

            socket.on('chat message', function(msg) {
                // To prevent re-rendering the whole chat history, modern browsers
                // will only add the new message.
                messagesPre.textContent += msg;
                scrollToBottom();
            });
        }
    </script>
</body>
</html>